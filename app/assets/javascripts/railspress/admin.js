/**
 * RailsPress Admin JavaScript
 * Vanilla JS for mobile menu and slug generation
 */

(function() {
  'use strict';

  // ============================================
  // Mobile Menu Toggle
  // ============================================

  function initMobileMenu() {
    const hamburger = document.querySelector('.rp-hamburger');
    const sidebar = document.querySelector('.rp-sidebar');
    const overlay = document.querySelector('.rp-overlay');

    if (!hamburger || !sidebar) return;

    function openMenu() {
      sidebar.classList.add('rp-sidebar--open');
      overlay?.classList.add('rp-overlay--visible');
      document.body.style.overflow = 'hidden';
      hamburger.setAttribute('aria-expanded', 'true');
    }

    function closeMenu() {
      sidebar.classList.remove('rp-sidebar--open');
      overlay?.classList.remove('rp-overlay--visible');
      document.body.style.overflow = '';
      hamburger.setAttribute('aria-expanded', 'false');
    }

    hamburger.addEventListener('click', function() {
      const isOpen = sidebar.classList.contains('rp-sidebar--open');
      if (isOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    overlay?.addEventListener('click', closeMenu);

    // Close on escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && sidebar.classList.contains('rp-sidebar--open')) {
        closeMenu();
        hamburger.focus();
      }
    });

    // Close on nav link click (mobile)
    const navLinks = sidebar.querySelectorAll('.rp-nav-link');
    navLinks.forEach(function(link) {
      link.addEventListener('click', function() {
        if (window.innerWidth < 768) {
          closeMenu();
        }
      });
    });

    // Handle resize
    let resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(function() {
        if (window.innerWidth >= 768) {
          closeMenu();
        }
      }, 100);
    });
  }

  // ============================================
  // Slug Generator
  // ============================================

  function initSlugGenerator() {
    const sourceInput = document.querySelector('[data-slug-source]');
    const slugInput = document.querySelector('[data-slug-target]');

    if (!sourceInput || !slugInput) return;

    let isAutoGenerated = !slugInput.value;

    function generateSlug(text) {
      return text
        .toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '')  // Remove special chars
        .replace(/\s+/g, '-')       // Replace spaces with dashes
        .replace(/-+/g, '-')        // Collapse multiple dashes
        .replace(/^-+|-+$/g, '');   // Trim dashes from ends
    }

    sourceInput.addEventListener('input', function() {
      if (isAutoGenerated) {
        slugInput.value = generateSlug(this.value);
      }
    });

    // Stop auto-generating if user manually edits slug
    slugInput.addEventListener('input', function() {
      isAutoGenerated = false;
    });

    // Resume auto-generation if slug is cleared
    slugInput.addEventListener('blur', function() {
      if (!this.value) {
        isAutoGenerated = true;
        if (sourceInput.value) {
          this.value = generateSlug(sourceInput.value);
        }
      }
    });
  }

  // ============================================
  // Delete Confirmation
  // ============================================

  function initDeleteConfirmation() {
    const deleteButtons = document.querySelectorAll('[data-confirm]');

    deleteButtons.forEach(function(button) {
      button.addEventListener('click', function(e) {
        const message = this.dataset.confirm || 'Are you sure?';
        if (!confirm(message)) {
          e.preventDefault();
        }
      });
    });
  }

  // ============================================
  // Flash Message Auto-dismiss
  // ============================================

  function initFlashMessages() {
    const flashes = document.querySelectorAll('.rp-flash');

    flashes.forEach(function(flash) {
      // Add close button
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '&times;';
      closeBtn.className = 'rp-flash-close';
      closeBtn.style.cssText = 'background: none; border: none; font-size: 1.25rem; cursor: pointer; margin-left: auto; opacity: 0.7;';
      closeBtn.setAttribute('aria-label', 'Dismiss');

      closeBtn.addEventListener('click', function() {
        flash.style.opacity = '0';
        flash.style.transform = 'translateY(-10px)';
        setTimeout(function() {
          flash.remove();
        }, 200);
      });

      flash.appendChild(closeBtn);

      // Auto-dismiss after 5 seconds
      setTimeout(function() {
        flash.style.opacity = '0';
        flash.style.transform = 'translateY(-10px)';
        setTimeout(function() {
          flash.remove();
        }, 200);
      }, 5000);
    });
  }

  // ============================================
  // Form Validation Styles
  // ============================================

  function initFormValidation() {
    const inputs = document.querySelectorAll('.rp-input, .rp-select');

    inputs.forEach(function(input) {
      input.addEventListener('invalid', function() {
        this.style.borderColor = 'var(--rp-danger)';
      });

      input.addEventListener('input', function() {
        if (this.validity.valid) {
          this.style.borderColor = '';
        }
      });
    });
  }

  // ============================================
  // Initialize on DOM Ready
  // ============================================

  function init() {
    initMobileMenu();
    initSlugGenerator();
    initDeleteConfirmation();
    initFlashMessages();
    initFormValidation();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

})();
