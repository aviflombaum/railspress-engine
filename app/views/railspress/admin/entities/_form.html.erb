<%= form_with model: @record,
    url: @record.persisted? ? entity_show_path(@record) : entity_index_path,
    class: "rp-form" do |form| %>

  <%= rp_form_errors(@record) %>

  <%
    # Separate fields into main content vs sidebar metadata vs attachments
    main_types = [:string, :text, :rich_text, :lines]
    sidebar_types = [:boolean, :integer, :decimal, :datetime, :date, :list]
    attachment_types = [:attachment, :attachments]

    main_fields = entity_config.fields.select { |_, f| main_types.include?(f[:type]) }
    sidebar_fields = entity_config.fields.select { |_, f| sidebar_types.include?(f[:type]) }
    attachment_fields = entity_config.fields.select { |_, f| attachment_types.include?(f[:type]) }
  %>

  <div class="rp-form-layout">
    <!-- Main content column -->
    <div class="rp-form-main">
      <% main_fields.each_with_index do |(name, field), index| %>
        <%= rp_render_field(form, name,
              type: field[:type],
              primary: index == 0,
              required: @record.class.validators_on(name).any? { |v| v.is_a?(ActiveModel::Validations::PresenceValidator) }) %>
      <% end %>
    </div>

    <% if sidebar_fields.any? || attachment_fields.any? %>
      <!-- Sidebar column -->
      <div class="rp-form-sidebar">
        <% if sidebar_fields.any? %>
          <%= rp_sidebar_section("Options") do %>
            <% sidebar_fields.each do |name, field| %>
              <%= rp_render_field(form, name, type: field[:type]) %>
            <% end %>
          <% end %>
        <% end %>

        <% attachment_fields.each do |name, field| %>
          <%= rp_sidebar_section(name.to_s.humanize) do %>
            <%= rp_render_field(form, name,
                  type: field[:type],
                  param_key: entity_config.param_key) %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <%= rp_form_actions(form, entity_index_path) %>
<% end %>
