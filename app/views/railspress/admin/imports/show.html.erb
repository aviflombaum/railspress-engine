<div class="rp-page-header">
  <h1 class="rp-page-title">Import <%= @import_type.titleize %></h1>
  <div class="rp-page-actions">
    <%= link_to "Back to #{@import_type.titleize}", send("admin_#{@import_type}_path"), class: "rp-btn rp-btn--secondary" %>
  </div>
</div>

<div class="rp-import-layout">
  <div class="rp-import-main">
    <div class="rp-card rp-card--padded">
      <%= form_with url: admin_imports_path, method: :post, multipart: true, class: "rp-form" do |form| %>
        <%= hidden_field_tag "import[import_type]", @import_type %>

        <label for="import_file" class="rp-dropzone" id="dropzone">
          <div class="rp-dropzone-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
          </div>
          <div class="rp-dropzone-text">
            <strong>Choose files or drag them here</strong>
            <span>Supports .md, .markdown, .txt, or .zip</span>
          </div>
          <%= file_field_tag "import[file][]", id: "import_file", class: "rp-dropzone-input", multiple: true, accept: ".md,.markdown,.txt,.zip" %>
        </label>

        <div id="file-list" class="rp-file-list" hidden></div>

        <div class="rp-form-actions">
          <%= form.submit "Start Import", class: "rp-btn rp-btn--primary", id: "submit-btn", disabled: true %>
        </div>
      <% end %>
    </div>

    <% if @recent_imports.any? %>
      <div class="rp-card" style="margin-top: var(--rp-space-lg);">
        <div class="rp-sidebar-section" style="background: transparent; border: none;">
          <h3 class="rp-sidebar-title">Recent Imports</h3>
        </div>
        <table class="rp-table">
          <thead>
            <tr>
              <th>File</th>
              <th>Status</th>
              <th>Results</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_imports.each do |import| %>
              <tr>
                <td class="rp-table-primary"><%= import.filename || "Multiple files" %></td>
                <td>
                  <span class="rp-badge rp-badge--<%= import.status %>">
                    <%= import.status.titleize %>
                  </span>
                </td>
                <td class="rp-table-secondary">
                  <%= import.success_count %>/<%= import.total_count %> succeeded
                  <% if import.error_count > 0 %>
                    <span class="rp-text-danger">(<%= import.error_count %> errors)</span>
                  <% end %>
                </td>
                <td class="rp-table-secondary"><%= import.created_at.strftime("%b %d, %Y %H:%M") %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </div>

  <div class="rp-import-sidebar">
    <%= render "instructions" %>
  </div>
</div>

<script>
(function() {
  var dropzone = document.getElementById('dropzone');
  var input = document.getElementById('import_file');
  var fileList = document.getElementById('file-list');
  var submitBtn = document.getElementById('submit-btn');

  // Drag and drop
  ['dragenter', 'dragover'].forEach(function(event) {
    dropzone.addEventListener(event, function(e) {
      e.preventDefault();
      dropzone.classList.add('rp-dropzone--active');
    });
  });

  ['dragleave', 'drop'].forEach(function(event) {
    dropzone.addEventListener(event, function(e) {
      e.preventDefault();
      dropzone.classList.remove('rp-dropzone--active');
    });
  });

  dropzone.addEventListener('drop', function(e) {
    input.files = e.dataTransfer.files;
    updateFileList();
  });

  // File input change
  input.addEventListener('change', updateFileList);

  function updateFileList() {
    var files = input.files;
    if (files.length === 0) {
      fileList.hidden = true;
      submitBtn.disabled = true;
      return;
    }

    var html = '';
    for (var i = 0; i < files.length; i++) {
      html += '<div class="rp-file-item">' +
        '<span class="rp-file-name">' + files[i].name + '</span>' +
        '<span class="rp-file-size">' + formatSize(files[i].size) + '</span>' +
        '</div>';
    }

    fileList.innerHTML = html;
    fileList.hidden = false;
    submitBtn.disabled = false;
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }
})();
</script>
