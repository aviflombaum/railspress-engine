<%= form_with model: [:admin, @post], class: "rp-form" do |form| %>
  <% if @post.errors.any? %>
    <div class="rp-form-errors">
      <ul>
        <% @post.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="rp-form-layout">
    <!-- Main content column -->
    <div class="rp-form-main">
      <div class="rp-form-group">
        <%= form.label :title, class: "rp-label" %>
        <%= form.text_field :title,
            class: "rp-input rp-input--title",
            placeholder: "Enter post title...",
            data: { slug_source: true },
            required: true %>
      </div>

      <div class="rp-form-group">
        <%= form.label :slug, class: "rp-label" %>
        <%= form.text_field :slug,
            class: "rp-input rp-input--mono",
            placeholder: "auto-generated-from-title",
            data: { slug_target: true } %>
        <p class="rp-hint">Leave blank to auto-generate from title</p>
      </div>

      <div class="rp-form-group" data-markdown-mode>
        <div class="rp-editor-header">
          <%= form.label :content, class: "rp-label" %>
          <div class="rp-editor-mode-toggle">
            <button type="button"
                    class="rp-btn rp-btn--small rp-btn--ghost"
                    data-markdown-toggle
                    aria-pressed="false"
                    title="Toggle markdown mode">
              <span data-mode-label="rich">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
                </svg>
                Markdown
              </span>
              <span data-mode-label="markdown" hidden>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                  <line x1="9" y1="9" x2="15" y2="9"/>
                  <line x1="9" y1="13" x2="15" y2="13"/>
                  <line x1="9" y1="17" x2="12" y2="17"/>
                </svg>
                Rich Text
              </span>
            </button>
          </div>
        </div>
        <%= form.rich_text_area :content, class: "rp-rich-text" %>
        <textarea data-markdown-textarea
                  class="rp-markdown-editor"
                  placeholder="Write in Markdown..."
                  hidden></textarea>
        <p class="rp-hint">
          <span data-mode-label="rich">Rich text editor powered by Lexxy. Click "Markdown" to edit raw markdown.</span>
          <span data-mode-label="markdown" hidden>Editing in Markdown mode. Supports **bold**, *italic*, # headings, - lists, and more.</span>
        </p>
      </div>
    </div>

    <!-- Sidebar column -->
    <div class="rp-form-sidebar">
      <div class="rp-sidebar-section">
        <h3 class="rp-sidebar-title">Publishing</h3>

        <div class="rp-form-group">
          <%= form.label :status, class: "rp-label" %>
          <%= form.select :status,
              Railspress::Post.statuses.keys.map { |s| [s.titleize, s] },
              {},
              class: "rp-select" %>
        </div>

        <div class="rp-form-group">
          <%= form.label :published_at, "Publish Date", class: "rp-label" %>
          <%= form.datetime_local_field :published_at,
              class: "rp-input",
              value: @post.published_at || Time.current %>
        </div>

        <div class="rp-form-group">
          <%= form.label :reading_time, "Reading Time (min)", class: "rp-label" %>
          <div class="rp-input-with-button">
            <%= form.number_field :reading_time,
                class: "rp-input",
                min: 1,
                placeholder: @post.persisted? ? @post.calculate_reading_time : "Auto" %>
            <% if @post.persisted? %>
              <button type="button"
                      class="rp-btn rp-btn--secondary rp-btn--sm"
                      onclick="this.previousElementSibling.value = '<%= @post.calculate_reading_time %>'">
                Calculate
              </button>
            <% end %>
          </div>
          <p class="rp-hint">Leave blank to auto-calculate from content</p>
        </div>

        <div class="rp-form-group">
          <%= form.label :category_id, "Category", class: "rp-label" %>
          <%= form.collection_select :category_id, @categories, :id, :name,
              { prompt: "No category" },
              { class: "rp-select" } %>
        </div>

        <% if authors_enabled? %>
          <div class="rp-form-group">
            <%= form.label :author_id, "Author", class: "rp-label" %>
            <%= form.collection_select :author_id, available_authors, :id, Railspress.author_display_method,
                { prompt: "No author", selected: @post.author_id },
                { class: "rp-select" } %>
          </div>
        <% end %>

        <div class="rp-form-group">
          <%= form.label :tag_list, "Tags", class: "rp-label" %>
          <%= form.text_field :tag_list,
              class: "rp-input",
              placeholder: "ruby, rails, tutorial",
              value: @post.tag_list %>
          <p class="rp-hint">Comma-separated. New tags created automatically.</p>
        </div>
      </div>

      <% if header_images_enabled? %>
        <div class="rp-sidebar-section">
          <h3 class="rp-sidebar-title">Featured Image</h3>

          <div class="rp-form-group">
            <% if @post.header_image.attached? && @post.header_image.blob&.persisted? %>
              <div class="rp-featured-image-preview">
                <%= image_tag main_app.url_for(@post.header_image.variant(resize_to_limit: [400, 300])), class: "rp-featured-image-thumb" %>
              </div>
            <% end %>

            <%= form.label :header_image, "Featured Image", class: "rp-label" %>
            <%= form.file_field :header_image, accept: "image/*", class: "rp-file-input" %>
            <p class="rp-hint">Recommended: 1200x630px for social sharing</p>

            <% if @post.header_image.attached? && @post.header_image.blob&.persisted? %>
              <label class="rp-checkbox-label">
                <%= form.check_box :remove_header_image, {}, "1", "0" %>
                Remove featured image
              </label>
            <% end %>
          </div>
        </div>
      <% end %>

      <div class="rp-sidebar-section">
        <h3 class="rp-sidebar-title">SEO</h3>

        <div class="rp-form-group">
          <%= form.label :meta_title, class: "rp-label" %>
          <%= form.text_field :meta_title,
              class: "rp-input",
              placeholder: "Defaults to post title" %>
        </div>

        <div class="rp-form-group">
          <%= form.label :meta_description, class: "rp-label" %>
          <%= form.text_area :meta_description,
              class: "rp-input",
              rows: 3,
              placeholder: "Brief description for search engines" %>
        </div>
      </div>
    </div>
  </div>

  <div class="rp-form-actions">
    <%= form.submit class: "rp-btn rp-btn--primary" %>
    <%= link_to "Cancel", admin_posts_path, class: "rp-btn rp-btn--secondary" %>
  </div>
<% end %>
